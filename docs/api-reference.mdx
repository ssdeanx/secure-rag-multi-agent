import {
    Badge,
    Button,
    Card,
    CardContent,
    CardDescription,
    CardHeader,
    CardTitle,
    Tabs,
    TabsContent,
    TabsList,
    TabsTrigger,
    Alert,
    AlertDescription,
    AlertTitle,
    Mermaid,
    Shield,
    Database,
    CheckCircle,
    ArrowRight,
    Code,
    Zap,
    Lock,
    FileText,
    Typography,
    Box,
    Table,
    XCircle,
    Clock,
} from '@/components/docs/mdx-bridge.joy'

# API Reference

The Multi-Domain AI Orchestration Platform provides comprehensive API endpoints for document indexing, secure querying, and agent orchestration across 5 capability domains. All endpoints use Mastra workflows and enforce security policies.

<Box
    sx={{
        display: 'flex',
        flexWrap: 'wrap',
        justifyContent: 'center',
        gap: 1,
        mb: 3,
    }}
>
    <Badge variant="soft" startDecorator={<Shield sx={{ fontSize: 12 }} />}>
        Security First
    </Badge>
    <Badge variant="soft" startDecorator={<FileText sx={{ fontSize: 12 }} />}>
        Streaming Responses
    </Badge>
    <Badge variant="soft" startDecorator={<Database sx={{ fontSize: 12 }} />}>
        PgVector Database
    </Badge>
    <Badge variant="soft" startDecorator={<Lock sx={{ fontSize: 12 }} />}>
        JWT Authentication
    </Badge>
</Box>

<!-- toc -->

## API Overview

<Mermaid
    chart={`graph TD
    subgraph "Client"
        UI[Frontend App]
    end
    subgraph "API Layer"
        ChatAPI[POST /api/chat]
        ResumeAPI[POST /api/chat/resume]
        IndexAPI[POST /api/index]
    end
    subgraph "Mastra Workflows"
        ChatWF[Chat Workflow<br/>Auth → Retrieve → Rerank → Generate → Verify]
        IndexWF[Index Workflow<br/>Process → Chunk → Embed → Store]
    end
    subgraph "Security"
        Auth[JWT Authentication]
        RBAC[Role-Based Access Control]
        Policy[Security Policies]
    end
    subgraph "Data"
        VectorDB[(PgVector<br/>Vectors)]
        DocStore[(Document Store<br/>Metadata)]
    end
    UI --> ChatAPI
    UI --> ResumeAPI
    UI --> IndexAPI
    ChatAPI --> ChatWF
    IndexAPI --> IndexWF
    ChatWF --> Auth
    IndexWF --> Auth
    Auth --> RBAC
    RBAC --> Policy
    ChatWF --> VectorDB
    IndexWF --> VectorDB
    ChatWF --> DocStore
    IndexWF --> DocStore
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef api fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef workflow fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef security fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef data fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    class UI client
    class ChatAPI,ResumeAPI,IndexAPI api
    class ChatWF,IndexWF workflow
    class Auth,RBAC,Policy security
    class VectorDB,DocStore data
`}
/>

<Box sx={{ display: 'grid', gridTemplateColumns: { xs: '1fr', md: 'repeat(2, 1fr)' }, gap: 3, mb: 3 }}>
  <Card variant="outlined">
    <CardHeader>
      <CardTitle sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
        <FileText sx={{ fontSize: 20, color: 'primary.main' }} />
        Chat Endpoint
      </CardTitle>
      <CardDescription>
        Secure conversational queries with streaming responses and role-based document access
      </CardDescription>
    </CardHeader>
    <CardContent>
      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, fontSize: '0.875rem' }}>
          <CheckCircle sx={{ fontSize: 16, color: 'success.main' }} />
          <Typography level="body-sm">JWT Authentication Required</Typography>
        </Box>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, fontSize: '0.875rem' }}>
          <CheckCircle sx={{ fontSize: 16, color: 'success.main' }} />
          <Typography level="body-sm">Server-Sent Events Streaming</Typography>
        </Box>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, fontSize: '0.875rem' }}>
          <CheckCircle sx={{ fontSize: 16, color: 'success.main' }} />
          <Typography level="body-sm">Role-Based Document Filtering</Typography>
        </Box>
      </Box>
    </CardContent>
  </Card>

  <Card variant="outlined">
    <CardHeader>
      <CardTitle sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
        <Database sx={{ fontSize: 20, color: 'secondary.main' }} />
        Index Endpoint
      </CardTitle>
      <CardDescription>
        Automated document processing and vector embedding with security classification
      </CardDescription>
    </CardHeader>
    <CardContent>
      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, fontSize: '0.875rem' }}>
          <CheckCircle sx={{ fontSize: 16, color: 'success.main' }} />
          <Typography level="body-sm">Automatic Document Classification</Typography>
        </Box>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, fontSize: '0.875rem' }}>
          <CheckCircle sx={{ fontSize: 16, color: 'success.main' }} />
          <Typography level="body-sm">Chunking & Embedding Pipeline</Typography>
        </Box>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, fontSize: '0.875rem' }}>
          <CheckCircle sx={{ fontSize: 16, color: 'success.main' }} />
          <Typography level="body-sm">JWT Optional (Admin Context)</Typography>
        </Box>
      </Box>
    </CardContent>
  </Card>
</Box>

## Endpoints

### POST /api/chat

**Description**: Processes a user question through the governed RAG workflow: authenticate → retrieve filtered docs → rerank → generate answer → verify. Streams the response as Server-Sent Events (SSE).

<Mermaid
    chart={`graph LR
    A[User Query] --> B[JWT Validation]
    B --> C[Role-Based Filtering]
    C --> D[Document Retrieval]
    D --> E[Re-ranking]
    E --> F[Answer Generation]
    F --> G[Security Verification]
    G --> H[Streaming Response]
    B --> B1[400: Invalid JWT]
    C --> C1[403: Access Denied]
    D --> D1[404: No Documents]
    G --> G1[500: Verification Failed]
    classDef process fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    class A,C,D,E,F,G,H process
    class B1,C1,D1,G1 error
`}
/>

**Path**: `POST /api/chat`

**Request Body** (JSON, required):

```json
{
    "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "question": "What is the expense reimbursement policy?"
}
```

<Box
    sx={{
        display: 'grid',
        gridTemplateColumns: { xs: '1fr', md: 'repeat(2, 1fr)' },
        gap: 3,
        mb: 3,
    }}
>
    <Box>
        <Typography sx={{ fontWeight: 'bold', mb: 1 }}>
            Required Fields
        </Typography>
        <Box
            component="ul"
            sx={{
                m: 0,
                pl: 2,
                '& li': {
                    mb: 1,
                    display: 'flex',
                    alignItems: 'center',
                    gap: 1,
                },
            }}
        >
            <li>
                <Badge
                    variant="soft"
                    color="danger"
                    sx={{ fontSize: '0.75rem' }}
                >
                    Required
                </Badge>
                <Typography component="code" sx={{ fontSize: '0.875rem' }}>
                    jwt
                </Typography>{' '}
                - JWT token with role claims
            </li>
            <li>
                <Badge
                    variant="soft"
                    color="danger"
                    sx={{ fontSize: '0.75rem' }}
                >
                    Required
                </Badge>
                <Typography component="code" sx={{ fontSize: '0.875rem' }}>
                    question
                </Typography>{' '}
                - Natural language query
            </li>
        </Box>
    </Box>
    <Box>
        <Typography sx={{ fontWeight: 'bold', mb: 1 }}>
            Response Format
        </Typography>
        <Box
            component="ul"
            sx={{
                m: 0,
                pl: 2,
                '& li': {
                    mb: 1,
                    display: 'flex',
                    alignItems: 'center',
                    gap: 1,
                },
            }}
        >
            <li>
                <Zap sx={{ fontSize: 12, color: 'primary.main' }} />
                <Typography level="body-sm">
                    Server-Sent Events (SSE)
                </Typography>
            </li>
            <li>
                <CheckCircle sx={{ fontSize: 12, color: 'success.main' }} />
                <Typography level="body-sm">~50ms chunk streaming</Typography>
            </li>
            <li>
                <FileText sx={{ fontSize: 12, color: 'secondary.main' }} />
                <Typography level="body-sm">
                    Final metadata with citations
                </Typography>
            </li>
        </Box>
    </Box>
</Box>

**Stream Format**:

<Tabs defaultValue="chunks">
  <TabsList>
    <TabsTrigger value="chunks">Data Chunks</TabsTrigger>
    <TabsTrigger value="final">Final Message</TabsTrigger>
    <TabsTrigger value="errors">Error Handling</TabsTrigger>
  </TabsList>

  <TabsContent value="chunks">
    ```javascript
// Streaming data chunks
data: {"content": "The expense reimbursement policy requires..."}\n\n
data: {"content": "submission within 30 days."}\n\n
    ```
  </TabsContent>

  <TabsContent value="final">
    ```javascript
// Final message with metadata
data: {"done": true, "citations": [
  {"docId": "finance-policy-001", "source": "Finance Department Policy Manual"}
], "contexts": []}\n\n
    ```
  </TabsContent>

  <TabsContent value="errors">
    ```javascript
// Error in stream
data: {"content": "⚠️ Error message", "done": true}\n\n
    ```
  </TabsContent>
</Tabs>

**Example Request**:

```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "jwt": "YOUR_JWT_TOKEN",
    "question": "What is our finance policy?"
  }'
```

**Error Responses**:

<Box sx={{ display: 'grid', gridTemplateColumns: { xs: '1fr', md: 'repeat(2, 1fr)' }, gap: 3, mb: 3 }}>
  <Alert color="danger">
    <XCircle sx={{ fontSize: 16 }} />
    <AlertTitle>400 Bad Request</AlertTitle>
    <AlertDescription>Missing required fields (jwt or question)</AlertDescription>
  </Alert>

  <Alert color="danger">
    <XCircle sx={{ fontSize: 16 }} />
    <AlertTitle>500 Internal Server Error</AlertTitle>
    <AlertDescription>Workflow failure or authentication error</AlertDescription>
  </Alert>
</Box>

### POST /api/chat/resume

**Description**: Resumes a previously suspended chat workflow, allowing for interactive, multi-step conversations. Takes a workflow runId and resume data to continue execution from the suspension point.

<Mermaid
    chart={`graph LR
    A[Suspended Workflow] --> B[JWT Validation]
    B --> C[Run ID Verification]
    C --> D[Resume Data Processing]
    D --> E[Workflow Continuation]
    E --> F[Streaming Response]
    B --> B1[400: Invalid JWT]
    C --> C1[404: Run Not Found]
    D --> D1[400: Invalid Resume Data]
    classDef process fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    class A,C,D,E,F process
    class B1,C1,D1 error
`}
/>

**Path**: `POST /api/chat/resume`

**Request Body** (JSON, required):

```json
{
    "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "runId": "run_1234567890abcdef",
    "step": "researchApproval",
    "resumeData": {
        "approved": true,
        "comments": "Approved for further research"
    },
    "stream": true
}
```

**Response** (Server-Sent Events stream):

```bash
data: {"content": "Continuing research based on approval..."}

data: {"content": "Gathering additional information..."}

data: {"done": true, "citations": [...]}
```

**Parameters**:

- `jwt` (string, required): Valid JWT token for authentication
- `runId` (string, required): Unique identifier of the suspended workflow run
- `step` (string, optional): Specific step path to resume from (if multiple suspension points)
- `resumeData` (object, required): Data to provide to the resumed workflow
- `stream` (boolean, optional): Whether to stream the response (default: true)

**Error Responses**:

<Alert color="danger" sx={{ mb: 2 }}>
    <XCircle sx={{ fontSize: 16 }} />
    <AlertTitle>400 Bad Request</AlertTitle>
    <AlertDescription>
        Missing required fields or invalid resume data
    </AlertDescription>
</Alert>

<Alert color="danger" sx={{ mb: 2 }}>
    <XCircle sx={{ fontSize: 16 }} />
    <AlertTitle>404 Not Found</AlertTitle>
    <AlertDescription>
        Workflow run not found or already completed
    </AlertDescription>
</Alert>

<Alert color="danger" sx={{ mb: 2 }}>
    <XCircle sx={{ fontSize: 16 }} />
    <AlertTitle>500 Internal Server Error</AlertTitle>
    <AlertDescription>Workflow resumption failure</AlertDescription>
</Alert>

**Example Request**:

```bash
curl -X POST http://localhost:3000/api/chat/resume \
  -H "Content-Type: application/json" \
  -d '{
    "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "runId": "run_1234567890abcdef",
    "resumeData": {"approved": true}
  }'
```

### POST /api/index

**Description**: Indexes documents from `./corpus/` with security metadata. Runs the indexing workflow: process → chunk → embed → store in PgVector.

<Mermaid chart={`graph LR
    A[Document Files] --> B[Security Classification]
    B --> C[Text Processing]
    C --> D[Chunking]
    D --> E[Embedding Generation]
    E --> F[Vector Storage]
    F --> G[Metadata Indexing]
    B --> B1[Role Assignment]
    C --> C1[Content Extraction]
    E --> E1[Google Gemini Embeddings]
    F --> F1[PgVector Storage]
    classDef process fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef storage fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    class A,B,C,D,E,G process
    class F storage
    class B1,C1,E1,F1 process

`} />

**Path**: `POST /api/index`

**Request Body** (JSON, optional):

```json
{
    "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response** (JSON):

```json
{
    "success": true,
    "indexed": 3,
    "failed": 0,
    "documents": [
        {
            "docId": "finance-policy-001",
            "status": "success",
            "chunks": 12
        },
        {
            "docId": "hr-conf-001",
            "status": "failed",
            "error": "Indexing error message"
        }
    ]
}
```

**Default Classification Rules**:

<Box sx={{ overflowX: 'auto', mb: 3 }}>
    <Table sx={{ minWidth: 600 }}>
        <thead>
            <tr>
                <th
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                        textAlign: 'left',
                    }}
                >
                    Document
                </th>
                <th
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                        textAlign: 'left',
                    }}
                >
                    Classification
                </th>
                <th
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                        textAlign: 'left',
                    }}
                >
                    Allowed Roles
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    finance-policy.md
                </td>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    <Badge variant="soft" color="secondary">
                        Internal
                    </Badge>
                </td>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                        <Badge variant="outlined" sx={{ fontSize: '0.75rem' }}>
                            finance.viewer
                        </Badge>
                        <Badge variant="outlined" sx={{ fontSize: '0.75rem' }}>
                            finance.admin
                        </Badge>
                        <Badge variant="outlined" sx={{ fontSize: '0.75rem' }}>
                            employee
                        </Badge>
                    </Box>
                </td>
            </tr>
            <tr>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    engineering-handbook.md
                </td>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    <Badge variant="soft" color="secondary">
                        Internal
                    </Badge>
                </td>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                        <Badge variant="outlined" sx={{ fontSize: '0.75rem' }}>
                            engineering.admin
                        </Badge>
                        <Badge variant="outlined" sx={{ fontSize: '0.75rem' }}>
                            engineering.viewer
                        </Badge>
                        <Badge variant="outlined" sx={{ fontSize: '0.75rem' }}>
                            employee
                        </Badge>
                    </Box>
                </td>
            </tr>
            <tr>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    hr-confidential.md
                </td>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    <Badge variant="soft" color="danger">
                        Confidential
                    </Badge>
                </td>
                <td
                    style={{
                        border: '1px solid',
                        borderColor: 'divider',
                        padding: '16px',
                    }}
                >
                    <Badge variant="outlined" sx={{ fontSize: '0.75rem' }}>
                        hr.admin
                    </Badge>
                </td>
            </tr>
        </tbody>
    </Table>
</Box>

**Example Request**:

```bash
curl -X POST http://localhost:3000/api/index \
  -H "Content-Type: application/json" \
  -d '{}'
```

## Authentication & Security

<Mermaid
    chart={`graph TD
    A[JWT Token] --> B[Header Extraction]
    B --> C[Signature Verification]
    C --> D[Claims Validation]
    D --> E[Role Hierarchy Check]
    E --> F[Document Access Filter]
    D --> D1[Invalid Token]
    E --> E1[Insufficient Permissions]
    classDef process fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    class A,B,C,F process
    class D1,E1 error
`}
/>

### JWT Authentication

- **Generation**: Via UI (AuthPanel) or `scripts/make-jwt.js`
- **Claims Structure**:

```json
{
    "role": "finance.viewer",
    "tenant": "acme",
    "exp": 1634567890,
    "iat": 1634567890
}
```

- **Validation**: Against role hierarchy in `src/mastra/config/role-hierarchy.ts`

### Security Features

<Box sx={{ display: 'grid', gridTemplateColumns: { xs: '1fr', md: 'repeat(3, 1fr)' }, gap: 3, mb: 3 }}>
  <Card variant="outlined">
    <CardHeader>
      <CardTitle sx={{ fontSize: '0.875rem' }}>Role-Based Access</CardTitle>
    </CardHeader>
    <CardContent>
      <Typography level="body-sm" sx={{ color: 'text.tertiary' }}>
        Documents filtered by user roles and security classifications
      </Typography>
    </CardContent>
  </Card>

<Card variant="outlined">
    <CardHeader>
        <CardTitle sx={{ fontSize: '0.875rem' }}>Audit Logging</CardTitle>
    </CardHeader>
    <CardContent>
        <Typography level="body-sm" sx={{ color: 'text.tertiary' }}>
            All queries and responses logged with provenance metadata
        </Typography>
    </CardContent>
</Card>

  <Card variant="outlined">
    <CardHeader>
      <CardTitle sx={{ fontSize: '0.875rem' }}>Content Filtering</CardTitle>
    </CardHeader>
    <CardContent>
      <Typography level="body-sm" sx={{ color: 'text.tertiary' }}>
        Sensitive information redacted based on security policies
      </Typography>
    </CardContent>
  </Card>
</Box>

## Rate Limits & Headers

- **Rate Limiting**: Handled by Mastra (no explicit limits)
- **Concurrency**: Managed by Mastra workflow engine
- **Headers**: `Content-Type: application/json`
- **CORS**: Enabled for localhost development

## Quick Start Examples

<Tabs defaultValue="chat">
  <TabsList>
    <TabsTrigger value="chat">Chat Query</TabsTrigger>
    <TabsTrigger value="index">Document Indexing</TabsTrigger>
    <TabsTrigger value="auth">Authentication</TabsTrigger>
  </TabsList>

  <TabsContent value="chat">

    ```javascript
    // Frontend chat integration
    const response = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        jwt: userToken,
        question: "What is the expense policy?"
        })
    })

    const reader = response.body.getReader()
        while (true) {
    const { done, value } = await reader.read()
        if (done) break

    const chunk = new TextDecoder().decode(value)
    const lines = chunk.split('\n')

        for (const line of lines) {
    if (line.startsWith('data: ')) {
    const data = JSON.parse(line.slice(6))
        if (data.content) {
    // Append to UI
    appendToChat(data.content)
    }
    if (data.done) {
    // Show citations
    showCitations(data.citations)
        }
        }
        }
    }
    ```

  </TabsContent>

  <TabsContent value="index">

    ```javascript
    // Index documents programmatically
    const indexResponse = await fetch('/api/index', {

method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
jwt: adminToken // Optional
})
})

const result = await indexResponse.json()
console.log(`Indexed ${result.indexed} documents`)

    // Check logs for details
    // cat logs/mastra.log
    ```

  </TabsContent>

  <TabsContent value="auth">

    ```javascript

// Generate JWT token
import jwt from 'jsonwebtoken'

const payload = {
role: 'finance.viewer',
tenant: 'acme',
exp: Math.floor(Date.now() / 1000) + (24 _ 60 _ 60) // 24 hours
}

const token = jwt.sign(payload, process.env.JWT_SECRET)

    ```

  </TabsContent>
</Tabs>

<Box
    sx={{
        mt: 3,
        p: 3,
        bgcolor: 'primary.softBg',
        borderRadius: 1,
        border: '1px solid',
        borderColor: 'primary.outlinedBorder',
    }}
>
    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 2 }}>
        <Code sx={{ fontSize: 24, color: 'primary.main' }} />
        <Typography
            sx={{
                fontSize: '1.125rem',
                fontWeight: 'bold',
                color: 'primary.main',
            }}
        >
            Ready to Integrate?
        </Typography>
    </Box>
    <Typography sx={{ color: 'primary.main', mb: 2 }}>
        These APIs provide the foundation for secure, governed RAG interactions.
        For UI integration examples, see the Quick Start guide.
    </Typography>
    <Box sx={{ display: 'flex', gap: 1.5 }}>
        <Button
            component="a"
            href="/docs/quick-start"
            endDecorator={<ArrowRight sx={{ fontSize: 16 }} />}
        >
            Quick Start Guide
        </Button>
        <Button variant="outlined" component="a" href="/docs/security">
            Security Details
        </Button>
    </Box>
</Box>
